#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>

// --- THEME & COLORS ---
#define CYN "\033[1;36m"
#define YEL "\033[1;33m"
#define RED "\033[1;31m"
#define GRN "\033[1;32m"
#define MAG "\033[1;35m"
#define BLU "\033[1;34m"
#define RST "\033[0m"

typedef struct { 
    char user[50], pass[50]; 
    int played, won; 
} Player;

char b[3][3];
Player curr;

void screen() { 
#ifdef _WIN32 
    system("cls"); 
#else 
    system("clear"); 
#endif 
}

void show() {
    printf("\n\t\t" CYN "  1   2   3" RST);
    for(int i=0; i<3; i++) {
        printf("\n\t\t" CYN "%d " RST, i+1);
        for(int j=0; j<3; j++) {
            if(b[i][j]=='X') printf(GRN " X " RST);
            else if(b[i][j]=='O') printf(RED " O " RST);
            else printf(" . ");
            if(j<2) printf("|");
        }
        if(i<2) printf("\n\t\t  ---|---|---");
    }
    printf("\n\n");
}

int win() {
    for(int i=0; i<3; i++) {
        if(b[i][0]==b[i][1] && b[i][1]==b[i][2]) return 1;
        if(b[0][i]==b[1][i] && b[1][i]==b[2][i]) return 1;
    }
    if(b[0][0]==b[1][1] && b[1][1]==b[2][2]) return 1;
    if(b[0][2]==b[1][1] && b[1][1]==b[2][0]) return 1;
    return 0;
}

int set(int m, char s) {
    int r=(m-1)/3, c=(m-1)%3;
    if(m<1 || m>9 || b[r][c]=='X' || b[r][c]=='O') return 0;
    b[r][c] = s;
    return 1;
}

// --- FIXED HARD AI LOGIC ---
int getAI(int diff) {
    // Easy Mode: Random
    if(diff == 1) { 
        int m; do{m=rand()%9+1;}while(!set(m,'O')); return m; 
    }

    // Hard Mode Step 1: Check if AI can Win
    for(int i=1; i<=9; i++) {
        int r=(i-1)/3, c=(i-1)%3;
        if(b[r][c] != 'X' && b[r][c] != 'O') {
            char backup = b[r][c];
            b[r][c] = 'O';
            if(win()) return i; // Keep it there and win
            b[r][c] = backup; // Undo
        }
    }

    // Hard Mode Step 2: Check if Player is about to win and BLOCK
    for(int i=1; i<=9; i++) {
        int r=(i-1)/3, c=(i-1)%3;
        if(b[r][c] != 'X' && b[r][c] != 'O') {
            char backup = b[r][c];
            b[r][c] = 'X';
            if(win()) { b[r][c] = 'O'; return i; } // Found a threat! Block it.
            b[r][c] = backup; // Undo
        }
    }

    // Step 3: Otherwise, take center or move random
    if(b[1][1] != 'X' && b[1][1] != 'O') { set(5, 'O'); return 5; }
    return getAI(1);
}

void updateStats(int winStatus) {
    FILE *f = fopen("players.txt", "rb+");
    if(!f) return;
    Player p;
    curr.played++;
    if(winStatus) curr.won++;
    while(fread(&p, sizeof(Player), 1, f)) {
        if(strcmp(p.user, curr.user) == 0) {
            fseek(f, -sizeof(Player), SEEK_CUR);
            fwrite(&curr, sizeof(Player), 1, f);
            break;
        }
    }
    fclose(f);
}

// --- FIXED AUTH FLOW (Returns to Menu) ---
void auth() {
    int ch; char u[50], p[50];
    while(1) {
        screen();
        printf(MAG "=====================================\n   WELCOME TO TIC-TAC-TOE 2025\n=====================================\n" RST);
        printf(YEL "\n1. Login\n2. Register\n3. Exit\n" RST "Choice: "); 
        if(scanf("%d", &ch) != 1) { while(getchar() != '\n'); continue; }

        if(ch==3) exit(0);

        printf("Username: "); scanf("%s", u);
        printf("Password: "); scanf("%s", p);
        
        if(ch==2) {
            FILE *f = fopen("players.txt", "ab+");
            Player temp; strcpy(temp.user, u); strcpy(temp.pass, p); 
            temp.played=0; temp.won=0;
            fwrite(&temp, sizeof(Player), 1, f);
            fclose(f);
            printf(GRN "\nAccount Created! Now please Login.\n" RST);
            printf("Press Enter..."); getchar(); getchar();
            continue; // GO BACK TO MENU
        } 
        else if(ch==1) {
            FILE *f = fopen("players.txt", "rb");
            if(!f) { printf(RED "No users found!\n" RST); getchar(); getchar(); continue; }
            int found = 0;
            while(fread(&curr, sizeof(Player), 1, f)) {
                if(!strcmp(u, curr.user) && !strcmp(p, curr.pass)) { 
                    printf(GRN "\nHello %s! Win Rate: %.1f%%\n" RST, curr.user, (curr.played > 0) ? (float)curr.won/curr.played*100 : 0);
                    printf("Press Enter to continue..."); getchar(); getchar();
                    fclose(f); return; 
                }
            }
            fclose(f);
            printf(RED "Invalid Credentials!\n" RST); 
            printf("Press Enter..."); getchar(); getchar();
        }
    }
}

void play() {
    while(1) {
        int mode, diff=1, rounds, p1s=0, p2s=0; char p2n[50]="AI";
        screen();
        printf(MAG "--- MAIN MENU ---\n" RST);
        printf(BLU "1. vs AI (Bot)\n2. vs Friend (Local)\n3. Exit Game\n" RST "Selection: "); scanf("%d", &mode);
        if(mode==3) return;
        if(mode==1) { printf(YEL "Difficulty (1.Easy / 2.Hard): " RST); scanf("%d", &diff); }
        else { printf(YEL "Friend's Name: " RST); scanf("%s", p2n); }
        printf(YEL "Number of Rounds: " RST); scanf("%d", &rounds);

        for(int r=1; r<=rounds; r++) {
            for(int i=0; i<9; i++) b[i/3][i%3] = (i+1)+'0';
            int turn = (r%2==0), moves = 0;
            while(moves < 9) {
                screen();
                printf(MAG "ROUND %d/%d  |  SCORE: %s[%d] - %s[%d]\n" RST, r, rounds, curr.user, p1s, p2n, p2s);
                show();
                if(turn==0) {
                    int m; printf(GRN "%s's Move (1-9): " RST, curr.user); 
                    if(scanf("%d", &m) != 1) { while(getchar() != '\n'); continue; }
                    if(!set(m, 'X')) continue;
                    if(win()) { p1s++; break; }
                } else {
                    if(mode==1) { printf(RED "AI is thinking...\n" RST); getAI(diff); if(win()){ p2s++; break; } }
                    else { 
                        int m; printf(RED "%s's Move (1-9): " RST, p2n); 
                        if(scanf("%d", &m) != 1) { while(getchar() != '\n'); continue; }
                        if(!set(m, 'O')) continue; if(win()){ p2s++; break; } 
                    }
                }
                turn = !turn; moves++;
            }
            screen(); show();
            if(win()) printf(GRN "\n*** %s WINS ROUND %d! ***\n" RST, (turn==0?curr.user:p2n), r);
            else printf(YEL "\n*** ROUND DRAW! ***\n" RST);
            printf("Enter for next round..."); getchar(); getchar();
        }
        screen();
        printf(MAG "=============================\n    FINAL RESULT\n=============================\n" RST);
        printf("%s: %d | %s: %d\n", curr.user, p1s, p2n, p2s);
        if(p1s != p2s) {
            printf(GRN "\nWINNER: %s\n" RST, p1s > p2s ? curr.user : p2n);
            updateStats(p1s > p2s);
        } else printf(YEL "\nIT'S A TIE!\n" RST);
        printf("\nPress Enter to return to Menu..."); getchar();
    }
}

int main() { srand(time(0)); auth(); play(); return 0; }
